$(document).ready(function () {
	//设置日期
	setTime();
	initSelects();
	//设置树
	setTree();
	$("#LTEQueryMoTree").treeview("collapseAll", {silent: true});
	customDblClickFun();
	initElementTree();
	//设置表格
	setTable();

	//设置输入框状态
	setInputStatus();

	//数据库获取所有城市
	getAllCity();

	//初始化下拉框
	$("#subNetworks").multiselect({
		buttonWidth: "100%",
		enableFiltering: true,
		nonSelectedText: "请选择子网",
		filterPlaceholder: "搜索",
		nSelectedText: "项被选中",
		includeSelectAllOption: true,
		selectAllText: "全选/取消全选",
		allSelectedText: "已选中所有子网",
		maxHeight: 200,
		maxWidth: "100%"
	});

	//数据库获取对应subNwork
	$("#allCity").change(function () {
		getAllSubNetwork();
	});

	//数据库获取对应模式TDD/FDD
	$("#LTEFormat").change(function () {
		getFormatAllSubNetwork();
	});

	//设置小时/15分钟选择
	setHQSelect();

	//设置查询方式
	//setCheckedType();
	$("#checkedType").bootstrapToggle("off");


	$("#search").on("click", function () {
		doSearchLTE("table");
	});
	$("#save").on("click", function () {
		fileSave("file");
	});

	toogle("LTEQuery");
});


//导入小区
function toName(self) {
	$.ajaxFileUpload({
		url: "LTEQuery/uploadFile",
		//data : data,
		fileElementId: "fileImport",
		secureuri: false,
		dataType: "json",
		type: "post",
		success: function (data, status) {
			$("#cellInput").val(data);
		},
		error: function (data, status, e) {
			//alert("上传失败");
			layer.open({
				title: "提示",
				content: "上传失败"
			});
		}
	});
}

//清空模板树
function clearLteQuery() {
	$("#paramQueryMoErbs").val("");
	setTree();
	$("#LTEQueryMoTree").treeview("collapseAll", {silent: true});
	customDblClickFun();
}

//筛选模板树
function searchLTEQuery() {
	var inputData = $("#paramQueryMoErbs").val();
	inputData = $.trim(inputData);
	if (inputData == "") {
		setTree();
		customDblClickFun();
		return;
	}
	var params = {
		inputData: inputData
	};
	var url = "LTEQuery/searchLTETreeData";
	//var treeData;

	$.get("LTEQuery/searchLTETreeData", params, function (data) {
		console.log(data);
		//data = "["+data+"]";
		var tree = "#LTEQueryMoTree";
		$(tree).treeview({data: data});
		customDblClickFun();
	});

}

function setHQSelect() {
	$("#hourSelect").multiselect({
		buttonWidth: "100%",
		enableFiltering: true,
		nonSelectedText: "请选择小时",
		filterPlaceholder: "搜索",
		nSelectedText: "项被选中",
		includeSelectAllOption: true,
		selectAllText: "全选/取消全选",
		allSelectedText: "已选中所有小时",
		maxHeight: 200,
		maxWidth: "100%"
	});

	$("#quarterSelect").multiselect({
		dropRight: true,
		buttonWidth: "100%",
		//enableFiltering: true,
		nonSelectedText: "请选择15分钟",
		//filterPlaceholder:"搜索",
		nSelectedText: "项被选中",
		includeSelectAllOption: true,
		selectAllText: "全选/取消全选",
		allSelectedText: "已选中所有",
		maxHeight: 200,
		maxWidth: "100%"
	});
}

//获取所有被选择的城市
function getChooseCitys() {
	var citys = $("#allCity").val();
	return citys;
}

function getFormatAllSubNetwork() {
	var citys = getChooseCitys();
	var format = $("#LTEFormat").val();
	var params = {
		format: format,
		citys: citys
	};
	$.get("LTEQuery/getFormatAllSubNetwork", params, function (data) {
		var newOptions = [];
		var obj = {};
		$(data).each(function (k, v) {
			v = eval("(" + v + ")");
			obj = {
				label: v.text,
				value: v.value,
				selected: true
			};
			newOptions.push(obj);
		});
		$("#subNetworks").multiselect("dataprovider", newOptions);
	});
}

function getAllSubNetwork() {
	var citys = getChooseCitys();
	var format = $("#LTEFormat").val();
	var params = {
		format: format,
		citys: citys
	};

	$.get("LTEQuery/getAllSubNetwork", params, function (data) {
		var newOptions = [];
		var obj = {};
		$(data).each(function (k, v) {
			v = eval("(" + v + ")");
			obj = {
				label: v.text,
				value: v.value,
				selected: true
			};
			newOptions.push(obj);
		});
		$("#subNetworks").multiselect("dataprovider", newOptions);
	});
}

function getAllCity() {
	$("#allCity").multiselect({
		dropRight: true,
		buttonWidth: "100%",
		//enableFiltering: true,
		nonSelectedText: "请选择城市",
		//filterPlaceholder:"搜索",
		nSelectedText: "项被选中",
		includeSelectAllOption: true,
		selectAllText: "全选/取消全选",
		allSelectedText: "已选中所有平台类型",
		maxHeight: 200,
		maxWidth: "100%"
	});
	var url = "LTEQuery/getAllCity";
	$.ajax({
		type: "GET",
		url: url,
		dataType: "json",
		success: function (data) {
			var newOptions = [];
			var obj = {};
			$(data).each(function (k, v) {
				v = eval("(" + v + ")");
				obj = {
					label: v.text,
					value: v.value
				};
				newOptions.push(obj);
			});
			$("#allCity").multiselect("dataprovider", newOptions);
		}
	});
}

function setInputStatus() {
	$("#LTEFormat").removeAttr("disabled");
	//区域维度初始值设置
	$("#locationDim").val("city");
	$("#cellInput").attr("disabled", "true");
	$("#erbsInput").attr("disabled", "true");
	$("#cellInput").val("");
	$("#erbsInput").val("");
	$("#locationDim").change(function () {
		if ($("#locationDim").val() == "cell") {
			$("#cellInput").removeAttr("disabled");
			$("#erbsInput").removeAttr("disabled");
			$("#erbsInput").val("");
		}else if($("#locationDim").val() == "cellGroup"){
			$("#cellInput").removeAttr("disabled");
			$("#erbsInput").attr("disabled", "true");
			$("#erbsInput").val("");
		} else if ($("#locationDim").val() == "erbs" || $("#locationDim").val() == "erbsGroup") {
			$("#cellInput").attr("disabled", "true");
			$("#erbsInput").removeAttr("disabled");
			$("#cellInput").val("");
		} else {
			$("#cellInput").attr("disabled", "true");
			$("#erbsInput").attr("disabled", "true");
			$("#cellInput").val("");
			$("#erbsInput").val("");
		}
	});

	//时间维度初始值设置
	$("#timeDim").val("day");
	//$("#hourSelect").attr("disabled", "disabled");
	$("#quarterSelect").attr("disabled", "disabled");
	$("#timeDim").change(function () {
		if ($("#timeDim").val() == "hour" || $("#timeDim").val() == "hourgroup") {
			$("#quarterSelect").multiselect("disable");
			$("#hourSelect").multiselect("enable");
		} else if ($("#timeDim").val() == "quarter") {
			$("#quarterSelect").multiselect("enable");
			$("#hourSelect").multiselect("enable");
		} else {
			$("#hourSelect").multiselect("enable");
			$("#quarterSelect").multiselect("disable");
		}
	});
}

function setTable() {
	// $("#LTEQueryTable").bootgrid({	  //表格
	//	   ajax: true,
	//	   post: function ()
	//	   {
	//		   // To accumulate custom parameter with the request object
	//		   return {
	//			   id: "b0df282a-0d67-40e5-8558-c9e93b7befed"
	//		   };
	//	   },
	//	   url: "common/json/test.json"/*,
	//	   formatters: {
	//		   "link": function(column, row)
	//		   {
	//			   return "<a href=\"#\">" + column.id + ": " + row.id + "</a>";
	//		   }
	//	   }*/
	//   });
}

function setTree() {
	var tree = "#LTEQueryMoTree";
	$(tree).treeview({data: getTree()}); //树
}

function setTime() {
	$("#startTime").datepicker({format: "yyyy-mm-dd"});  //返回日期
	$("#endTime").datepicker({format: "yyyy-mm-dd"});

	var nowTemp = new Date();
	$("#startTime").datepicker("setValue", nowTemp);
	$("#endTime").datepicker("setValue", nowTemp);
	var now = new Date(nowTemp.getFullYear(), nowTemp.getMonth(), nowTemp.getDate(), 0, 0, 0, 0);
	var checkin = $("#startTime").datepicker({
		onRender: function (date) {
			return date.valueOf() < now.valueOf() ? "" : "";
		}
	}).on("changeDate", function (ev) {
		if (ev.date.valueOf() > checkout.date.valueOf()) {
			var newDate = new Date(ev.date);
			newDate.setDate(newDate.getDate() + 1);
			checkout.setValue(newDate);
		}
		checkin.hide();
		$("#endTime")[0].focus();
	}).data("datepicker");
	var checkout = $("#endTime").datepicker({
		onRender: function (date) {
			//return date.valueOf() <= checkin.date.valueOf() ? "disabled" : "";
			return date.valueOf() <= checkin.date.valueOf() ? "" : "";
		}
	}).on("changeDate", function (ev) {
		checkout.hide();
	}).data("datepicker");

}

function getTree() {
	var url = "LTEQuery/getLTETreeData";
	var treeData;
	$.ajax({
		type: "GET",
		url: url,
		dataType: "json",
		async: false,
		success: function (data) {
			treeData = data;
		}
	});
	return treeData;
}

//获取input框输入的值 
function getParams(action) {
	var locationDim = $("#locationDim").val();
	var timeDim = $("#timeDim").val();
	var startTime = $("#startTime").val();
	var endTime = $("#endTime").val();
	var format = $("#LTEFormat").val();
	var citys = $("#allCity").val();
	if (citys == null) {
		//alert("请选择城市!");
		layer.open({
			title: "提示",
			content: "请选择城市"
		});
		return false;
	}
	var subNetworks = $("#subNetworks").val();
	if (subNetworks == null) {
		//alert("请选择subNetwork！");
		layer.open({
			title: "提示",
			content: "请选择subNetwork"
		});
		return false;
	}
	var LTETree = $("#LTEQueryMoTree").treeview("getSelected");
	if (LTETree == "") {
		//alert("请选择模板名称！");
		layer.open({
			title: "提示",
			content: "请选择模板名称"
		});
		return false;
	}
	var moTree = LTETree[0].text;
	var hour = $("#hourSelect").val();
	var min = $("#quarterSelect").val();
	var cell = $("#cellInput").val();
	var erbs = $("#erbsInput").val();
	var parent = $("#LTEQueryMoTree").treeview("getParent", LTETree[0].nodeId).text;

	var flag = $("#checkedType").prop("checked");
	var checkStyle;
	if (flag) {
		checkStyle = "local";
	} else {
		checkStyle = "online";
	}

	var params = {
		template: moTree,
		locationDim: locationDim,
		timeDim: timeDim,
		startTime: startTime,
		endTime: endTime,
		hour: JSON.stringify(hour),//hour,
		//hour:hour,
		minute: JSON.stringify(min),//min,
		city: JSON.stringify(citys),//citys,
		subNet: JSON.stringify(subNetworks),//subNetworks,
		erbs: erbs,
		cell: cell,
		format: format,
		style: checkStyle,
		action: action,
		parent: parent
	};
	return params;
}


/*function show_confirm(xhr)
 {
 var r=confirm("请求超时,出现未知情况，是否愿意继续等待？");
 if (r!=true)
 {
 l.stop();
 S.stop();
 E.stop();
 xhr.abort();
 }
 }*/

//查询
function doSearchLTE(table) {
	var flag = $("#checkedType").prop("checked");
	var route;
	if (flag) {
		route = "LTEQuery/templateQueryOnline";
		if ($("#LTEFormat").val() == "FDD") {
			//alert("本地不能查询FDD");
			layer.open({
				title: "提示",
				content: "本地不能查询FDD"
			});
			$("#checkedType").bootstrapToggle("off");
			return;
		}
		if ($("#timeDim").val() == "quarter") {
			//alert("本地不能查询15分钟");
			layer.open({
				title: "提示",
				content: "本地不能查询15分钟"
			});
			$("#checkedType").bootstrapToggle("off");
			return;
		}
	} else {
		route = "LTEQuery/templateQueryLocal";
	}

	var l = Ladda.create(document.getElementById("search"));
	var S = Ladda.create(document.getElementById("save"));
	var E = Ladda.create(document.getElementById("export"));

	l.start();
	S.start();
	E.start();
	var params = getParams();
	if (params == false) {
		l.stop();
		S.stop();
		E.stop();
		return false;
	}


	var timeout = setTimeout(function () {   // post设置超时时间
		/*var r=confirm("请求超时,出现未知情况，是否愿意继续等待？");
		 if (r!=true)
		 {
		 l.stop();
		 S.stop();
		 E.stop();
		 xhr.abort();
		 }*/
		layer.confirm("请求超时,出现未知情况，是否愿意继续等待？", {title: "提示"}, function (index) {
			layer.close(index);
		}, function (index) {
			l.stop();
			S.stop();
			E.stop();
			xhr.abort();
			layer.close(index);
		});
	}, setPDOSearchTime("lteQuery"));


	var xhr = $.ajax({
		type: "POST",
		url: "LTEQuery/templateQuery",
		data: params,
		success: function (data) {
			// $("#search").on("click", function () {
			// 	doSearchLTE("table");
			// });
			// if (timeout) { //清除定时器
			// 	clearTimeout(timeout);
			// 	timeout = null;
			// }

				
			 	 //返回值为空，结束加载状态，返回错误。
			 	 var datajson = JSON.parse(data).value;
			 	 if(datajson == ""){
			 	
			 	 		l.stop(); 
						S.stop();
						E.stop();
			 	
			 	 		layer.open({
			 	 		
			 	 			title:"提示",
			 	 			content:"JSON.parse(data).error",
			 	 		});
			 	
			 		return false;
			 	 }





			if ((JSON.parse(data).error).indexOf("Caught exception:") != -1) {
				l.stop();
				S.stop();
				E.stop();
				layer.open({
					title: "提示",
					content: JSON.parse(data).error
				});
				return false;
			}
			if ((JSON.parse(data).error).indexOf("check:") != -1) {
				l.stop();
				S.stop();
				E.stop();
				layer.open({
					title: '提示',
					content: JSON.parse(data).error
				});
				return false;
			}
			if (JSON.parse(data).error == "NOTFINDLINE") {
				l.stop();
				S.stop();
				E.stop();
				//alert("不存在的字段名");
				layer.open({
					title: "提示",
					content: "不存在的字段名"
				});
				return false;
			}

			if (JSON.parse(data).state == "overflow") {
				layer.open({
					title: "提示",
					content: "由于查询数据大于100万条，导出将按照100万条取！"
				});
			}

			$("#LTEQueryFile").val(JSON.parse(data).filename);
			var fieldArr = [];
			var text = (JSON.parse(data).text).split(",");
			for (var i in JSON.parse(data).rows[0]) {
				fieldArr[fieldArr.length] = {
					field: i,
					title: text[fieldArr.length],
					width: textWidth(text[fieldArr.length])
				};
			}
			var newData = JSON.parse(data).rows;

			$("#LTEQueryTable").grid("destroy", true, true);
			$("#LTEQueryTable").grid({
				columns: fieldArr,
				dataSource: newData,
				pager: {limit: 10, sizes: [10, 20, 50, 100]},
				autoScroll: true,
				uiLibrary: "bootstrap"
			});
			if (table == "file") {
				//alert(JSON.parse(data).filename);
				layer.open({
					title: "提示",
					content: JSON.parse(data).filename,
					yes:function(index, layero){
						download(JSON.parse(data).filename);
						layer.close(index);
					}
				});
				
			}
			l.stop();
			S.stop();
			E.stop();
		}
	});
	/* $.post("LTEQuery/templateQuery", params, function(data){
	 if((JSON.parse(data).error).indexOf("Caught exception:") != -1){
	 l.stop();
	 S.stop();
	 E.stop();
	 alert(JSON.parse(data).error);
	 return false;
	 }
	 if(JSON.parse(data).error == "NOTFINDLINE"){
	 l.stop();
	 S.stop();
	 E.stop();
	 alert("不存在的字段名");
	 return false;
	 }
	 $("#LTEQueryFile").val(JSON.parse(data).filename);
	 var fieldArr=[];
	 var text=(JSON.parse(data).text).split(",");
	 for(var i in JSON.parse(data).rows[0]){
	 fieldArr[fieldArr.length]={field:i,title:text[fieldArr.length],width:textWidth(text[fieldArr.length])};
	 }
	 var newData = JSON.parse(data).rows;

	 $("#LTEQueryTable").grid("destroy", true, true);
	 $("#LTEQueryTable").grid({
	 columns:fieldArr,
	 dataSource:newData,
	 pager: { limit: 10, sizes: [10, 20, 50, 100] },
	 autoScroll:true,
	 uiLibrary: "bootstrap"
	 });
	 if(table == "file") {
	 alert(JSON.parse(data).filename);
	 download(JSON.parse(data).filename);
	 }
	 l.stop();
	 S.stop();
	 E.stop();
	 });*/
}

function textWidth(text) {
	var length = text.length;
	if (length > 15) {
		return length * 10;
	}
	return 150;
}


function fileSave(table) {
	var fileName = $("#LTEQueryFile").val();
	if (fileName != "") {
		//alert(fileName);
		layer.open({
			title: "提示",
			content: fileName,
			yes:function(index, layero){
				var fileNames = csvZipDownload(fileName);
				download(fileNames);
				layer.close(index);
			}
		});
		
	}
	else {
		//alert("No file generated so far!");
		layer.open({
			title: "提示",
			content: "下载失败"
		});
	}
	$("#save").on("click", function () {
		fileSave("file");
	});
}

function download(url) {
	var browerInfo = getBrowerInfo();
	if (browerInfo == "chrome") {
		download_chrome(url);
	} else if (browerInfo == "firefox") {
		download_firefox(url);
	}
}

function download_chrome(url) {
	var aLink = document.createElement("a");
	aLink.href = url;
	aLink.download = url;
	/*var evt = document.createEvent("HTMLEvents");
	 evt.initEvent("click", false, false);
	 aLink.dispatchEvent(evt);*/
	document.body.appendChild(aLink);
	aLink.click();
}

function download_firefox(url) {
	window.open(url);
}

function getBrowerInfo() {
	var uerAgent = navigator.userAgent.toLowerCase();
	var format = /(msie|firefox|chrome|opera|version).*?([\d.]+)/;
	var matches = uerAgent.match(format);
	return matches[1].replace(/version/, "'safari");
}

//最后一次触发节点Id
var lastSelectedNodeText = null;
//最后一次触发时间
var lastSelectTime = null;
//自定义业务方法
function customBusiness(data) {
	if (!data.nodes) {
		var text = data.text;
		var id = data.id;
		// console.log(data.nodeId);
		// console.log(data.id);
		// var parent = $("#LTEQueryMoTree").treeview("getParent", data.nodeId).text;
		$("#mtitle").html("指标-" + text);
		$("#checkTemplate").modal();
		$("#formula").html("");
		setElementTree(id);
	}

}
function clickNode(event, data) {
	if (lastSelectedNodeText && lastSelectTime) {
		var time = new Date().getTime();
		var t = time - lastSelectTime;
		if (lastSelectedNodeText == data.id && t < 300) {
			customBusiness(data);
		}
	}
	lastSelectedNodeText = data.id;
	lastSelectTime = new Date().getTime();
	$("#customName").val(data.id);
}
//自定义双击事件
function customDblClickFun() {
	//节点选中时触发
	$("#LTEQueryMoTree").on("nodeSelected", function (event, data) {
		clickNode(event, data);
	});
	//节点取消选中时触发
	$("#LTEQueryMoTree").on("nodeUnselected", function (event, data) {
		clickNode(event, data);
	});
}

function initElementTree() {
	var tree = "#LTEElementTree";
	$(tree).treeview({
		data: null
	}); //树
}

function setElementTree(id) {
	var tree = "#LTEElementTree";
	$(tree).treeview({
		data: getElementTree(id),
		onNodeSelected: function (event, data) {
			$("#formula").html(data.formula);
		}
	}); //树
}

function getElementTree(id) {

	var url = "LTEQuery/getElementTree";
	var treeData;
	$.ajax({
		type: "GET",
		url: url,
		data: {
			templateId: id,
		},
		dataType: "json",
		async: false,
		success: function (data) {
			$("#elementIds").val(data.elementId);
			treeData = getKpiNamebyId(data.elementId);
		}
	});
	return treeData;
}
function getKpiNamebyId(id) {
	var url = "LTEQuery/getKpiNamebyId";
	var treeData;
	$.ajax({
		type: "GET",
		url: url,
		data: {
			id: id
		},
		dataType: "json",
		async: false,
		success: function (data) {
			treeData = data;
		}
	});
	return treeData;
}
function initSelects() {
	$("#locationDim").multiselect({
		dropRight: true,
		buttonWidth: "100%",
		//enableFiltering: true,
		nonSelectedText: "请选择区域维度",
		//filterPlaceholder:"搜索",
		//nSelectedText:"项被选中",
		//includeSelectAllOption:true,
		//selectAllText:"全选/取消全选",
		//allSelectedText:"已选中所有平台类型",
		maxHeight: 200,
		maxWidth: "100%"
	});
	$("#timeDim").multiselect({
		dropRight: true,
		buttonWidth: "100%",
		//enableFiltering: true,
		nonSelectedText: "请选择时间维度",
		//filterPlaceholder:"搜索",
		//nSelectedText:"项被选中",
		//includeSelectAllOption:true,
		//selectAllText:"全选/取消全选",
		//allSelectedText:"已选中所有平台类型",
		maxHeight: 200,
		maxWidth: "100%"
	});
	$("#LTEFormat").multiselect({
		dropRight: true,
		buttonWidth: "100%",
		//enableFiltering: true,
		nonSelectedText: "请选择制式",
		//filterPlaceholder:"搜索",
		//nSelectedText:"项被选中",
		//includeSelectAllOption:true,
		//selectAllText:"全选/取消全选",
		//allSelectedText:"已选中所有平台类型",
		maxHeight: 200,
		maxWidth: "100%"
	});
}